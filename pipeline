pipeline {
    agent any
    environment {
        REGION_GCP = "us-central1"
        ZONE_GCP = "us-central1-a"
        IMAGE_NAME = "docker-cloud"
        PROJECT_ID = "mythic-inn-420620"
        IMAGE_TAG = "latest"
        DOCKER_HUB = "ganesh6498/docker-cloud"
        ARTIFACT_REPO = "${REGION_GCP}-docker.pkg.dev/${PROJECT_ID}/my-docker-repo/${IMAGE_NAME}"
        GOOGLE_APPLICATION_CREDENTIALS = credentials('gcp-key')
    }

    stages {
        stage("Git Clone") {
            steps {
                git branch: 'main', url: 'https://github.com/ganesh-redy/docker-pipe-cloud-run.git'
            }
        }

        stage("Build Docker Image") {
            steps {
                sh 'docker build -t ${IMAGE_NAME}:${BUILD_NUMBER} .'
            }
        }

        stage("Authenticate with Docker Hub") {
            steps {
                withCredentials([usernamePassword(
                    credentialsId: "docker-hub-credential",
                    usernameVariable: "DOCKER_USER",
                    passwordVariable: "DOCKER_PASS"
                )]) {
                    sh 'echo "$DOCKER_PASS" | docker login -u "$DOCKER_USER" --password-stdin'
                }
            }
        }

        stage("Push Docker Image to Docker Hub") {
            steps {
                sh '''
                docker tag ${IMAGE_NAME}:${BUILD_NUMBER} ${DOCKER_HUB}:${BUILD_NUMBER}
                docker push ${DOCKER_HUB}:${BUILD_NUMBER}
                '''
            }
        }

        stage("Run Terraform & Push Docker Image in Parallel") {
            parallel {
                stage("Create Artifact Registry with Terraform") {
                    steps {
                        script {
                            sh '''
                            terraform init
                            terraform plan
                            terraform apply --auto-approve
                            '''
                        }
                    }
                }
                
                stage("Wait & Push Docker Image to Artifact Registry") {
                    steps {
                        script {
                            retry(3) {  
                                sh '''
            

                                echo "Waiting for Artifact Registry to be available..."
                                sleep 30
                                docker tag ${IMAGE_NAME}:${BUILD_NUMBER} $ARTIFACT_REPO:${BUILD_NUMBER}
                                docker push $ARTIFACT_REPO:${BUILD_NUMBER}
                                '''
                            }
                        }
                    }
                }
            }
        }
    }

    post {
        success {
            echo "Pipeline completed successfully! üöÄ"
        }
        failure {
            echo "Pipeline failed! ‚ùå"
        }
    }
}

